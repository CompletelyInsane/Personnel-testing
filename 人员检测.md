# Benewake(北醒) TF-Luna (TTL) 雷达在WiFi LoRa 32 (V3)基于Arduino IDE上的垃圾桶检测项目


# 一.前言
::: alert-info

   应用场景：在超市、图书馆、地铁等公共区域，需要对不同出入通道人流量进行统计，需要考虑成本问题以及隐私性，只需要统计出入流量，不搜集其他信息。

:::
----



# 二.硬件介绍

   | 物料     |  数量   |
   | --- | --- |
   |   HELTEC ESP32 Boards v3  |  x1  |
   |      TF-Luna (TTL)            |   x2   |

## 1.TF-Luna 简要说明
   ![TF-Luna 外观和特点](vx_images/470135116231067.png =700x)
![TF-Luna 技术规格书](vx_images/2055216249493.png =700x)
**相关链接：https://blog.csdn.net/zoran_wu/article/details/121850480**
## 2.WiFi LoRa 32 (V3)
![背面](vx_images/320405316237360.png =200x)     ![正面](vx_images/396065316257526.png =221x)



![WiFi LoRa 32 (V3) 开发板产品参数](vx_images/508565316250195.png =600x)
![WiFi LoRa 32 (V3)引脚图](vx_images/52035416246750.png =1000x)
官方资料请参考 :
https://heltec.org/project/wifi-lora-32-v3/
https://docs.heltec.org/zh_CN/node/esp32/wifi_lora_32/index.html


-----

# 三.编译环境搭建
## 1.安装Arduino
 参考官方教程 https://docs.heltec.org/general/how_to_install_git_and_arduino.html
 下载地址： https://www.arduino.cc/en/Main/Software 
![](vx_images/453865516257988.png =550x)
双击安装 Arduino 
![](vx_images/514255616254307.png =550x)
![](vx_images/27085716247853.png =550x)

## 2.安装芯片包和查看例程

###**通过本地文件的方式**
官方教程：https://docs.heltec.org/zh_CN/node/esp32/wifi_kit_8/quick_start.html#via-local-file
下载开发环境：https://resource.heltec.cn/download/tools/WiFi_Kit_series.zip

> 1. 打开 Arduino IDE，然后单击 -> FilePeferences
![](vx_images/123455916231517.png =500x)
> 2. 转到红色框中的文件夹。
![](vx_images/287015916234021.png =500x)
> 3. 在 Arduino 文件夹中创建一个新的“硬件”文件夹。如果已经有一个“硬件”文件夹，则无需创建新文件夹。
![](vx_images/410965916242968.png =500x)
> 4. 转到“硬件”文件夹并将“WiFi_Kit_series”提取到此文件夹中。
![](vx_images/585745916235853.png =500x)
> 5. 进入“WiFi_Kit_series”文件夹，参考下图确认红框中的路径是否正确。
![](vx_images/168120017236462.png =501x)
> 6. 重新启动 Arduino IDE，确认开发环境是否安装成功。
![](vx_images/353270017263417.png =674x)




---
# 四.各功能模块设计
## 总体思路：
::: alert-info
考虑人行走时的特点，需要实现可以分辨出是进还是出，并分开统计，在完成完整的进入或者出去的动作之后才进行计数。
设计方案为平行等高横向地安装两个雷达：
行人与两雷达相对位置的四个状态：
![](vx_images/345844516231150.png =605x)
识别两个动作
![](vx_images/486684516249576.png =573x)
增加 ：10->11->01  
减小： 01->11->10   
完成动作则进行增减
存储下时间上连续变化的三个状态，识别到完成了相应动作后，进行计数。
自适应逻辑：
两个雷达每测量一次都与设定的测量距离进行比较，如果连续一段时间测得的数据和设定的测量距离误差都超过了5cm，便自动更新测量距离为当前雷达测量值。

:::

## 1.测量端功能模块介绍
### （1）串口读取并处理雷达数据
**北醒TF-luna(TTL)协议说明**
     详细可参考北醒官网最新使用说明书：
     https://www.benewake.com/DataDownload/index_pid_20_lcid_21.html
![规格书](vx_images/13930617248447.png =700x)
::: alert-info

引脚 5 悬空或者接 3.3V 时，TF-Luna 启动为串口通信模式，引脚 2 为串口接收 RXD，引脚 3 为串口发送 TXD。
串口通信硬件协议为：数据位 8bit，停止位 1bit，无奇偶校验，默认波特率**115200bps**。

:::

![](vx_images/202430617249742.png =730x)
**雷达硬件接线图：**
![](vx_images/505310617250921.png =700x)
**串口2读取一帧数据，并用串口0打印出雷达距离信息的示例代码：**
```
#include "HardwareSerial.h"   
//雷达数据结构体
typedef struct {
  int distance = 0;        //距离
  int strength = 0;        //信号强度
  int ID   = 0;            //雷达 ID

  long int BaudRate = 0;

  boolean LidarFlag = false;
  boolean receiveComplete = false;
  boolean IO = 0;
} TF;
TF Lidar;

void getLidarData( TF* Lidar);

void setup() {
   Serial.begin(115200);  //串口0 用于打印调试
   Serial2.begin(115200, SERIAL_8N1, 45, 46);  //串口2用于读取雷达数据 绑定串口2的两个脚位 设置GPIO45是Rx，GPIO46是Tx
}

void loop() {
  getLidarData(&Lidar) ;
  Serial.print(Lidar.distance);
  Serial.println("cm");
  delay(500);
}


/* void getLidarData( TF* Lidar) 
   串口获取一帧数据，并计算距离，信号强度和记录成功计算的标志。
*/
void getLidarData( TF* Lidar)  
{ 
  //59 59 03 00 E9 09 68 09 18  一帧数据
  static char i = 0;
  char j = 0;
  int checksum = 0;
  Lidar->receiveComplete = false; 
  static int rx[9] ;
  while (Serial2.available() > 0) {
     rx[i] = Serial2.read();
    if (rx[0] != 0x59) {
      i = 0;
    } else if (i == 1 && rx[1] != 0x59) {
      i = 0;
    } else if (i == 8) {
      for (j = 0; j < 8; j++) {
        checksum += rx[j];      //计算校验和
      }
      if (rx[8] == (checksum % 256)) {
        Lidar->distance = rx[2] + rx[3] * 256;  //距离
        Lidar->strength = rx[4] + rx[5] * 256;  //信号强度
        Lidar->receiveComplete = true;          //接收完成
      }
      i = 0;
    } else {
      i++;
    }
   } 
}
```
串口信息：
![](vx_images/360460717236473.png =786x)



---

# 五.工程代码烧录
## 1.工程代码烧录
完整工程GIthub仓库：
>1. 下载工程
>2. 下载解压，进入目录 
>3. 双击打开工程
>4. 在设备管理器中查看对应端口
![](vx_images/157371610257527.png =603x)
>5. 正确选择开发板和端口
![](vx_images/243201610250196.png =603x)

![](vx_images/324301610246751.png =603x)
>6. 编译上传
![](vx_images/410101610242505.png =603x)
 
## 接线图
## 使用说明

::: alert-info
---